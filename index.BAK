<!DOCTYPE<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <title>My test page</title>

    <style>

div { margin: 2em }

img.title { width: 100%; }

blockquote {
position: relative;
margin: 2em 0;
padding: 1.2em;
font-size: .9em;
background: #DFDFDF;
}

    </style>

	<script language="javascript" type="module">

	import { getConfig } from './js/config.js';

	function createTable(config) {
  		const table = [];
  		for (const entry of config) {
  			const nonPickProb = entry.prob * entry.pickups.reduce((acc, x) => acc - x[1], 1) / (entry.ids.length - entry.pickups.length);
			for (const cid of entry.ids) {
				const searched = entry.pickups.find(x => x[0] === cid);
				const prob = (searched) ? entry.prob * searched[1] : nonPickProb;
			table.push([cid, prob]);
    			}
  		}
  	return table;
	}

	function gacha(config, rval) {
  		const table = createTable(config);

  		let accum = 0;
  		for (const [cid, prob] of table) {
  		  accum += prob;
  		  if (rval < accum) return cid;
  		}
  		throw new Error('should not reach here');
	}

        async function clickGachaButton() {
		const config = await getConfig();
		filename = 'img/chr/' + gacha(config, 0.001).id + '.png';
		target = document.getElementById("result_image");
          	target.src = filename;
        }

	const button = document.getElementById('gacha_button');
	button.addEventListener('click', clickGachaButton);

    </script>

  </head>
  <body>
    <img src="img/sys/logo.png" class="title" />
    <p>SNSなどで使えるフリーアイコンのガチャです。 #魔女図鑑</p>
    <input id="gacha_button" type="button" value="ガチャをひく">
    <img src="transparent.png" id="result_image">
  </body>
</html>
